<!DOCTYPE html>
<html>
  <head>
    

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    

    <title>Building real time Python applications with Django Channels, Docker and Kubernetes</title>
    <meta name="description"
          content="Three years ago I wrote an article about webockets. In fact I’ve written several articles about Websockets (Websockets and real time communications is something that I’m really passionate about), but today I would like to pick up this article. Nowadays I’m involved with several Django projects so I want to create a similar working prototype with Django. Let’s start:

">
    <meta name="author" content="Gonzalo Ayuso">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Building real time Python applications with Django Channels, Docker and Kubernetes">
    <meta name="twitter:description"
          content="Three years ago I wrote an article about webockets. In fact I’ve written several articles about Websockets (Websockets and real time communications is something that I’m really passionate about), but today I would like to pick up this article. Nowadays I’m involved with several Django projects so I want to create a similar working prototype with Django. Let’s start:

">
    
    <meta name="twitter:creator" content="gonzalo123">
    
    <meta name="twitter:image" content="/images/favicons/favicon-194x194.png"/>

    <meta property="og:type" content="article">
    <meta property="og:title" content="Building real time Python applications with Django Channels, Docker and Kubernetes">
    <meta property="og:description"
          content="Three years ago I wrote an article about webockets. In fact I’ve written several articles about Websockets (Websockets and real time communications is something that I’m really passionate about), but today I would like to pick up this article. Nowadays I’m involved with several Django projects so I want to create a similar working prototype with Django. Let’s start:

">
    <meta property="og:image" content="/images/favicons/favicon-194x194.png"/>

    <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png"
          sizes="192x192">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/images/favicons/manifest.json">
    <link rel="shortcut icon" href="/images/favicons/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="/css/main.css?1617650803001959000">
    <link rel="canonical"
          href="/2020/05/04/real-time-python-applications-with-django-channels-docker-and-kubernetes/">
    <link rel="alternate" type="application/rss+xml" title="Gonzalo Ayuso" href="/feed.xml">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Building real time Python applications with Django Channels, Docker and Kubernetes | Gonzalo Ayuso</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Building real time Python applications with Django Channels, Docker and Kubernetes" />
<meta name="author" content="Gonzalo Ayuso" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Three years ago I wrote an article about webockets. In fact I’ve written several articles about Websockets (Websockets and real time communications is something that I’m really passionate about), but today I would like to pick up this article. Nowadays I’m involved with several Django projects so I want to create a similar working prototype with Django. Let’s start:" />
<meta property="og:description" content="Three years ago I wrote an article about webockets. In fact I’ve written several articles about Websockets (Websockets and real time communications is something that I’m really passionate about), but today I would like to pick up this article. Nowadays I’m involved with several Django projects so I want to create a similar working prototype with Django. Let’s start:" />
<link rel="canonical" href="/2020/05/04/real-time-python-applications-with-django-channels-docker-and-kubernetes/" />
<meta property="og:url" content="/2020/05/04/real-time-python-applications-with-django-channels-docker-and-kubernetes/" />
<meta property="og:site_name" content="Gonzalo Ayuso" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-04T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Building real time Python applications with Django Channels, Docker and Kubernetes" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"/2020/05/04/real-time-python-applications-with-django-channels-docker-and-kubernetes/"},"url":"/2020/05/04/real-time-python-applications-with-django-channels-docker-and-kubernetes/","author":{"@type":"Person","name":"Gonzalo Ayuso"},"description":"Three years ago I wrote an article about webockets. In fact I’ve written several articles about Websockets (Websockets and real time communications is something that I’m really passionate about), but today I would like to pick up this article. Nowadays I’m involved with several Django projects so I want to create a similar working prototype with Django. Let’s start:","dateModified":"2020-05-04T00:00:00+02:00","datePublished":"2020-05-04T00:00:00+02:00","headline":"Building real time Python applications with Django Channels, Docker and Kubernetes","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>

    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover panel-cover--collapsed"
        style="background-image: url(/images/cover.jpg)">
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content">
                <a href="/" title="link to home of Gonzalo Ayuso">
                    <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
                    <h1 class="panel-cover__title panel-title">Gonzalo Ayuso</h1>
                    <h3 class="panel-cover__title panel-title"><i>Web Architect</i></h3>
                </a>
                <div class="navigation-wrapper">
                    <h3 class="panel-cover__title panel-title"><i>Personal blog since 2008</i></h3>
                    <nav class="cover-navigation navigation--social">
                        <nav class="cover-navigation">
                            <ul class="navigation">
                                <li class="navigation__item">
                                    <a href="/about" title="about">
                                        <span>About Me</span>
                                    </a>
                                </li>
                                <li class="navigation__item">
                                    <a href="/posts" title="posts">
                                        <span>All</span>
                                    </a>
                                </li>
                                <li class="navigation__item">
                                    <a href="/search" title="search">
                                        <span>Search</span>
                                    </a>
                                </li>

                            </ul>
                        </nav>
                        <hr class="panel-cover__divider">
                        <ul class="navigation">
    
    <!-- Twitter -->
    <li class="navigation__item">
        <a href="http://twitter.com/gonzalo123"
           title="@gonzalo123 on Twitter" target="_blank">
            <i class="icon icon-social-twitter"></i>
            <span class="label">Twitter</span>
        </a>
    </li>
    

    
    <!-- LinkedIn -->
    <li class="navigation__item">
        <a href="https://www.linkedin.com/in/gonzaloayuso"
           title="gonzaloayuso on LinkedIn" target="_blank">
            <i class="icon icon-social-linkedin"></i>
            <span class="label">LinkedIn</span>
        </a>
    </li>
    

    
    <!-- GitHub -->
    <li class="navigation__item">
        <a href="https://www.github.com/gonzalo123"
           title="gonzalo123 on GitHub" target="_blank">
            <i class="icon icon-social-github"></i>
            <span class="label">GitHub</span>
        </a>
    </li>
    

    
    <!-- Email -->
    <li class="navigation__item">
        <a href="mailto:gonzalo123@gmail.com" title="Email gonzalo123@gmail.com"
           target="_blank">
            <i class="icon icon-mail"></i>
            <span class="label">Email</span>
        </a>
    </li>
    

    <!-- RSS -->
    <li class="navigation__item">
        <a href="/feed.xml" title="Subscribe" target="_blank">
            <i class="icon icon-rss"></i>
            <span class="label">RSS</span>
        </a>
    </li>

</ul>

                    </nav>
                    <div>
    <a href="/book">
        <img src="/assets/images/codigoSolido.png" alt="Código Sólido">
    </a>
</div>

                </div>

            </div>

        </div>

        <div class="panel-cover--overlay"></div>
    </div>
</header>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <header
            class="post-header"
            
        class="cover-banner"
        style="background-image: url(119958.png);"
        
    >
        <div class="post-meta">
            <time datetime=" 2020-05-04 00:00
            " class="post-meta__date date">4 May 2020</time>
            
            &#8226; <span class="post-meta__tags">on <a
                href="/tags/#channels">channels</a>, <a
                href="/tags/#django">django</a>, <a
                href="/tags/#docker">docker</a>, <a
                href="/tags/#k8s">k8s</a>, <a
                href="/tags/#python">python</a>, <a
                href="/tags/#websockets">websockets</a>, <a
                href="/tags/#ws">ws</a></span>
            
        </div>
        <h1 class="post-title">Building real time Python applications with Django Channels, Docker and Kubernetes</h1>
    </header>

    <section class="post">
        <p>Three years ago I wrote an <a href="https://gonzalo123.com/2017/01/02/playing-with-docker-silex-python-node-and-Websockets/">article</a> about webockets. In fact I’ve written several articles about Websockets (Websockets and real time communications is something that I’m really passionate about), but today I would like to pick up this article. Nowadays I’m involved with several Django projects so I want to create a similar working prototype with Django. Let’s start:</p>

<p>In the past I normally worked with libraries such as socket.io to ensure browser compatibility with Websockets. Nowadays, at least in my world, we can assume that our users are using a modern browser with websocket support, so we’re going to use plain Websockets instead external libraries. Django has a great support to Websockets called <a href="https://channels.readthedocs.io/">Django Channels</a>. It allows us to to handle Websockets (and other async protocols) thanks to Python’s ASGI’s specification. In fact is pretty straightforward to build applications with real time communication and with shared authentication (something that I have done in the past with a lot of effort. I’m getting old and now I like simple things :))</p>

<p>The application that I want to build is the following one: One Web application that shows the current time with seconds. Ok it’s very simple to do it with a couple of javascript lines but this time I want to create a worker that emits an event via Websockets with the current time. My web application will show that real time update. This kind of architecture always have the same problem: The initial state. In this example we can ignore it. When the user opens the browser it must show the current time. As I said before in this example we can ignore this situation. We can wait until the next event to update the initial blank information but if the event arrives each 10 seconds our user will have a blank screen until the next event arrives. In our example we’re going to take into account this situation. Each time our user connects to the Websocket it will ask to the server for the initial state.</p>

<p>Our initial state route will return the current time (using Redis). We can authorize our route using the standard Django’s protected routes</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">ws.redis</span> <span class="kn">import</span> <span class="n">redis</span>
 
<span class="o">@</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">initial_state</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s">'current'</span><span class="p">:</span> <span class="n">redis</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'time'</span><span class="p">)})</span>
</code></pre></div></div>

<p>We need to configure our channels and define a our event:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">re_path</span>
 
<span class="kn">from</span> <span class="nn">ws</span> <span class="kn">import</span> <span class="n">consumers</span>
 
<span class="n">websocket_urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re_path</span><span class="p">(</span><span class="sa">r</span><span class="s">'time/tic/$'</span><span class="p">,</span> <span class="n">consumers</span><span class="p">.</span><span class="n">WsConsumer</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>As we can see here we can reuse the authentication middleware in channel’s consumers also.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">channels.generic.websocket</span> <span class="kn">import</span> <span class="n">AsyncWebsocketConsumer</span>
 
 
<span class="k">class</span> <span class="nc">WsConsumer</span><span class="p">(</span><span class="n">AsyncWebsocketConsumer</span><span class="p">):</span>
    <span class="n">GROUP</span> <span class="o">=</span> <span class="s">'time'</span>
 
    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">scope</span><span class="p">[</span><span class="s">"user"</span><span class="p">].</span><span class="n">is_anonymous</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">channel_layer</span><span class="p">.</span><span class="n">group_add</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">GROUP</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">channel_name</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
 
    <span class="k">async</span> <span class="k">def</span> <span class="nf">tic_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">scope</span><span class="p">[</span><span class="s">"user"</span><span class="p">].</span><span class="n">is_anonymous</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">'message'</span><span class="p">]</span>
 
            <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">text_data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s">'message'</span><span class="p">:</span> <span class="n">message</span>
            <span class="p">}))</span>
</code></pre></div></div>

<p>We’re going to need a worker that each second triggers the current time (to avoid problems we’re going to trigger our event each 0.5 seconds). To perform those kind of actions Django has a great tool called <a href="http://www.celeryproject.org/">Celery</a>. We can create workers and scheduled task with Celery (exactly what we need in our example). To avoid the “initial state” situation our worker will persists the initial state into a Redis storage</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'config'</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s">'django.conf:settings'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'CELERY'</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">autodiscover_tasks</span><span class="p">()</span>
 
 
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">on_after_configure</span><span class="p">.</span><span class="n">connect</span>
<span class="k">def</span> <span class="nf">setup_periodic_tasks</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
   <span class="n">sender</span><span class="p">.</span><span class="n">add_periodic_task</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ws_beat</span><span class="p">.</span><span class="n">s</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'beat every 0.5 seconds'</span><span class="p">)</span>
 
 
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">ws_beat</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">WsConsumer</span><span class="p">.</span><span class="n">GROUP</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s">'tic_message'</span><span class="p">):</span>
   <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%X'</span><span class="p">)</span>
   <span class="n">redis</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">'time'</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>
   <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">'time'</span><span class="p">:</span> <span class="n">current_time</span><span class="p">}</span>
   <span class="n">channel_layer</span> <span class="o">=</span> <span class="n">channels</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">get_channel_layer</span><span class="p">()</span>
   <span class="n">async_to_sync</span><span class="p">(</span><span class="n">channel_layer</span><span class="p">.</span><span class="n">group_send</span><span class="p">)(</span><span class="n">group</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="s">'message'</span><span class="p">:</span> <span class="n">message</span><span class="p">})</span>
</code></pre></div></div>

<p>Finally we need a javascript client to consume our Websockets</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">getWsUri</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">https:</span><span class="dl">"</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">wss</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">ws</span><span class="dl">"</span> <span class="o">+</span>
    <span class="dl">'</span><span class="s1">://</span><span class="dl">'</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span>
    <span class="dl">"</span><span class="s2">/time/tic/</span><span class="dl">"</span>
<span class="p">}</span>
 
<span class="kd">let</span> <span class="nx">render</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">#display</span><span class="dl">'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">value</span>
<span class="p">}</span>
 
<span class="kd">let</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReconnectingWebSocket</span><span class="p">(</span><span class="nx">getWsUri</span><span class="p">())</span>
 
<span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">time</span><span class="p">)</span>
<span class="p">}</span>
 
<span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/initial_state</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Basically that’s the source code (plus Django the stuff).</p>

<p><strong>Application architecture</strong> The architecture of the application is the following one:</p>

<p><strong>Frontend</strong> The Django application. We can run this application in development with python manage.py runserver</p>

<p>And in production using a asgi server (uvicorn in this case)</p>

<pre><code class="language-commandline">uvicorn config.asgi:application --port 8000 --host 0.0.0.0 --workers 1
</code></pre>

<p>In development mode:</p>

<pre><code class="language-commandline">celery -A ws worker -l debug
</code></pre>
<p>And in production</p>

<pre><code class="language-commandline">celery -A ws worker --uid=nobody --gid=nogroup
</code></pre>

<p>We need this scheduler to emit our event (each 0.5 seconds)</p>

<pre><code class="language-commandline">celery -A ws beat
</code></pre>

<p><strong>Message Server for Celery</strong> In this case we’re going to use Redis</p>

<p><strong>Docker</strong> With this application we can use the same dockerfile for frontend, worker and scheduler using different entrypoints</p>

<p>Dockerfile:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> python:3.8</span>
 
<span class="k">ENV</span><span class="s"> TZ 'Europe/Madrid'</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="nv">$TZ</span> <span class="o">&gt;</span> /etc/timezone <span class="o">&amp;&amp;</span> <span class="se">\
</span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> tzdata <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="nb">rm</span> /etc/localtime <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="nb">ln</span> <span class="nt">-snf</span> /usr/share/zoneinfo/<span class="nv">$TZ</span> /etc/localtime <span class="o">&amp;&amp;</span> <span class="se">\
</span>dpkg-reconfigure <span class="nt">-f</span> noninteractive tzdata <span class="o">&amp;&amp;</span> <span class="se">\
</span>apt-get clean
 
<span class="k">ENV</span><span class="s"> PYTHONDONTWRITEBYTECODE 1</span>
<span class="k">ENV</span><span class="s"> PYTHONUNBUFFERED 1</span>
 
<span class="k">ADD</span><span class="s"> . /src</span>
<span class="k">WORKDIR</span><span class="s"> /src</span>
 
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
 
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /var/run/celery /var/log/celery
<span class="k">RUN </span><span class="nb">chown</span> <span class="nt">-R</span> nobody:nogroup /var/run/celery /var/log/celery
</code></pre></div></div>

<p>And our whole application within a docker-compose file</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.4'</span>
 
<span class="na">services</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">clock:latest</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">/bin/bash ./docker-entrypoint.sh</span>
    <span class="na">healthcheck</span><span class="pi">:</span>
      <span class="na">test</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">CMD"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">curl"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">http://localhost:8000/health"</span><span class="pi">]</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">1m30s</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">3</span>
      <span class="na">start_period</span><span class="pi">:</span> <span class="s">40s</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">redis"</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">8000:8000</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">ENVIRONMENT</span><span class="pi">:</span> <span class="s">prod</span>
      <span class="na">REDIS_HOST</span><span class="pi">:</span> <span class="s">redis</span>
  <span class="na">celery</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">clock:latest</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">celery -A ws worker --uid=nobody --gid=nogroup</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">redis"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">ENVIRONMENT</span><span class="pi">:</span> <span class="s">prod</span>
      <span class="na">REDIS_HOST</span><span class="pi">:</span> <span class="s">redis</span>
  <span class="na">cron</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">clock:latest</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">celery -A ws beat</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">redis"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">ENVIRONMENT</span><span class="pi">:</span> <span class="s">prod</span>
      <span class="na">REDIS_HOST</span><span class="pi">:</span> <span class="s">redis</span>
</code></pre></div></div>

<p>If we want to deploy our application in a K8s cluster we need to migrate our docker-compose file into a k8s yaml files. I assume that we’ve deployed our docker containers into a container registry (such as ECR)</p>

<p>Frontend:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-web-api</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">clock-web-api</span>
      <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">clock-web-api</span>
        <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">web-api</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">my-ecr-path/clock:latest</span>
          <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">uvicorn"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">config.asgi:application"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--port"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">8000"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--host"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">0.0.0.0"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--workers"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">1"</span><span class="pi">]</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8000</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REDIS_HOST</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-app-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">redis.host</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-web-api</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">clock-web-api</span>
    <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">8000</span> <span class="c1"># port exposed internally in the cluster</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8000</span> <span class="c1"># the container port to send requests to</span>
</code></pre></div></div>

<p>Celery worker</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-web-api</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">clock-web-api</span>
      <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">clock-web-api</span>
        <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">web-api</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">my-ecr-path/clock:latest</span>
          <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">uvicorn"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">config.asgi:application"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--port"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">8000"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--host"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">0.0.0.0"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--workers"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">1"</span><span class="pi">]</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8000</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REDIS_HOST</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-app-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">redis.host</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-web-api</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">clock-web-api</span>
    <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">8000</span> <span class="c1"># port exposed internally in the cluster</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8000</span> <span class="c1"># the container port to send requests to</span>
</code></pre></div></div>

<p>Celery scheduler</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-cron</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">clock-cron</span>
      <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">clock-cron</span>
        <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">clock-cron</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">my-ecr-path/clock:latest</span>
          <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">celery"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-A"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">ws"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">beat"</span><span class="pi">]</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REDIS_HOST</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-app-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">redis.host</span>
</code></pre></div></div>

<p>Redis</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-redis</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">clock-redis</span>
      <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">clock-redis</span>
        <span class="na">project</span><span class="pi">:</span> <span class="s">clock</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">clock-redis</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">6379</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">clock-redis</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-redis</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">6379</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">6379</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">clock-redis</span>
</code></pre></div></div>

<p>Shared configuration</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">clock-app-config</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">redis.host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">clock-redis"</span>
</code></pre></div></div>
<p>We can deploy or application to our k8s cluster</p>

<pre><code class="language-commandline">kubectl apply -f .k8s/
</code></pre>

<p>And see it running inside the cluster locally with a port forward</p>

<pre><code class="language-commandline">kubectl port-forward deployment/clock-web-api 8000:8000
</code></pre>

<p>And that’s all. Our Django application with Websockets using Django Channels up and running with docker and also using k8s.</p>

<p>Source code in my <a href="https://github.com/gonzalo123/clock">github</a></p>

    </section>
    <p>
        <div class="page-share">
  <a href="https://twitter.com/intent/tweet?text=Building+real+time+Python+applications+with+Django+Channels%2C+Docker+and+Kubernetes%20%2F2020%2F05%2F04%2Freal-time-python-applications-with-django-channels-docker-and-kubernetes%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2F2020%2F05%2F04%2Freal-time-python-applications-with-django-channels-docker-and-kubernetes%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=Building+real+time+Python+applications+with+Django+Channels%2C+Docker+and+Kubernetes&url=%2F2020%2F05%2F04%2Freal-time-python-applications-with-django-channels-docker-and-kubernetes%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

    </p>
    
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = '/2020/05/04/real-time-python-applications-with-django-channels-docker-and-kubernetes/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2020/05/04/real-time-python-applications-with-django-channels-docker-and-kubernetes'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//https-gonzalo123-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




<div class="relatedPosts">

<h4>Related Posts:</h4>





  
    
    
    

    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2021/01/11/playing-with-rabbitmq-python-and-docker-from-exchanges-to-queues/">Playing with RabbitMQ, Python and Docker. From Exchanges to Queues <span class="label label-default">docker</span>  <span class="label label-default">python</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    
      <div>
      <h5><a href="/2020/12/14/running-python-django-docker-containers-with-non-root-user/">Running Python/Django docker containers with non-root user <span class="label label-default">django</span>  <span class="label label-default">docker</span>  <span class="label label-default">python</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2020/10/26/django-logs-to-elk-using-filebeat/">Django logs to ELK using Filebeat <span class="label label-default">django</span>  <span class="label label-default">python</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    
      <div>
      <h5><a href="/2020/09/21/dont-repeat-password-validator-in-django/">Don't repeat password validator in Django <span class="label label-default">django</span>  <span class="label label-default">python</span> </a></h5>
      </div>
      
      
        

</div>

      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2021 Gonzalo Ayuso. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1617650803001959000"></script>

    </div>
  </body>
</html>
