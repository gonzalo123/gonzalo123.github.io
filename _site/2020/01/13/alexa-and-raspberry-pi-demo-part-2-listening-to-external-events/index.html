<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  

  <title>Alexa and Raspberry Pi demo (Part 2). Listening to external events</title>
  <meta name="description" content="Today I want to keep on with the previous example. This time I want to create one Alexa skill that listen to external events. The example that I’ve build is the following one:

">
  <meta name="author" content="Gonzalo Ayuso">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Alexa and Raspberry Pi demo (Part 2). Listening to external events">
  <meta name="twitter:description" content="Today I want to keep on with the previous example. This time I want to create one Alexa skill that listen to external events. The example that I’ve build is the following one:

">
  
  <meta name="twitter:creator" content="gonzalo123">
  
  <meta name="twitter:image" content="/images/favicons/favicon-194x194.png" />

  <meta property="og:type" content="article">
  <meta property="og:title" content="Alexa and Raspberry Pi demo (Part 2). Listening to external events">
  <meta property="og:description" content="Today I want to keep on with the previous example. This time I want to create one Alexa skill that listen to external events. The example that I’ve build is the following one:

">
  <meta property="og:image" content="/images/favicons/favicon-194x194.png" />

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <link rel="stylesheet" href="/css/main.css?1617390999503576000">
  <link rel="canonical" href="http://localhost:4000/2020/01/13/alexa-and-raspberry-pi-demo-part-2-listening-to-external-events/">
  <link rel="alternate" type="application/rss+xml" title="Gonzalo Ayuso" href="/feed.xml">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Alexa and Raspberry Pi demo (Part 2). Listening to external events | Gonzalo Ayuso</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Alexa and Raspberry Pi demo (Part 2). Listening to external events" />
<meta name="author" content="Gonzalo Ayuso" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Today I want to keep on with the previous example. This time I want to create one Alexa skill that listen to external events. The example that I’ve build is the following one:" />
<meta property="og:description" content="Today I want to keep on with the previous example. This time I want to create one Alexa skill that listen to external events. The example that I’ve build is the following one:" />
<link rel="canonical" href="http://localhost:4000/2020/01/13/alexa-and-raspberry-pi-demo-part-2-listening-to-external-events/" />
<meta property="og:url" content="http://localhost:4000/2020/01/13/alexa-and-raspberry-pi-demo-part-2-listening-to-external-events/" />
<meta property="og:site_name" content="Gonzalo Ayuso" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-13T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Alexa and Raspberry Pi demo (Part 2). Listening to external events" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/01/13/alexa-and-raspberry-pi-demo-part-2-listening-to-external-events/"},"url":"http://localhost:4000/2020/01/13/alexa-and-raspberry-pi-demo-part-2-listening-to-external-events/","author":{"@type":"Person","name":"Gonzalo Ayuso"},"description":"Today I want to keep on with the previous example. This time I want to create one Alexa skill that listen to external events. The example that I’ve build is the following one:","dateModified":"2020-01-13T00:00:00+01:00","datePublished":"2020-01-13T00:00:00+01:00","headline":"Alexa and Raspberry Pi demo (Part 2). Listening to external events","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover panel-cover--collapsed"
        style="background-image: url(/images/cover.jpg)">
    <div class="panel-main">

        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content">
                <a href="/" title="link to home of Gonzalo Ayuso">
                    <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
                    <h1 class="panel-cover__title panel-title">Gonzalo Ayuso</h1>
                    <h3 class="panel-cover__title panel-title"><i>Web Architect</i></h3>
                </a>
                <hr class="panel-cover__divider">
                <p class="panel-cover__description">Personal blog since 2008</p>
                <div class="navigation-wrapper">
                    <nav class="cover-navigation navigation--social">
                        <nav class="cover-navigation">
                            <ul class="navigation">
                                <li class="navigation__item">
                                    <a class="navigation__item" href="/about" title="about">
                                        About Me
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        <hr class="panel-cover__divider">
                        <ul class="navigation">
    
    <!-- Twitter -->
    <li class="navigation__item">
        <a href="http://twitter.com/gonzalo123"
           title="@gonzalo123 on Twitter" target="_blank">
            <i class="icon icon-social-twitter"></i>
            <span class="label">Twitter</span>
        </a>
    </li>
    

    
    <!-- LinkedIn -->
    <li class="navigation__item">
        <a href="https://www.linkedin.com/in/gonzaloayuso"
           title="gonzaloayuso on LinkedIn" target="_blank">
            <i class="icon icon-social-linkedin"></i>
            <span class="label">LinkedIn</span>
        </a>
    </li>
    

    
    <!-- GitHub -->
    <li class="navigation__item">
        <a href="https://www.github.com/gonzalo123"
           title="gonzalo123 on GitHub" target="_blank">
            <i class="icon icon-social-github"></i>
            <span class="label">GitHub</span>
        </a>
    </li>
    

    
    <!-- Email -->
    <li class="navigation__item">
        <a href="mailto:gonzalo123@gmail.com" title="Email gonzalo123@gmail.com"
           target="_blank">
            <i class="icon icon-mail"></i>
            <span class="label">Email</span>
        </a>
    </li>
    

    <!-- RSS -->
    <li class="navigation__item">
        <a href="/feed.xml" title="Subscribe" target="_blank">
            <i class="icon icon-rss"></i>
            <span class="label">RSS</span>
        </a>
    </li>

</ul>

                    </nav>
                    <div>
    <a href="https://leanpub.com/codigosolido"
       rel="noreferrer"
       data-ss1617366980="1">
        <img src="/assets/images/codigoSolido.png" alt="Código Sólido">
    </a>
    <p class="panel-cover__description">
        <i>
            Buy my book (Spanish) on Leanpub. (It's free but if you pay I'll donate all profits)
        </i>
    </p>
</div>

                    <form method="get" action="http://www.google.com/search" target="_blank">
    <input type="hidden"
           name="sitesearch"
           value="https://gonzalo123.com/"/>
    <input type="text"
           name="q"
           maxlength="255"
           placeholder="Search with Google"/>
</form>


                </div>

            </div>

        </div>

        <div class="panel-cover--overlay"></div>
    </div>
</header>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="2020-01-13 00:00" class="post-meta__date date">13 Jan 2020</time>
      
      &#8226; <span class="post-meta__tags">on <a href="/tags/#alexa">alexa</a>, <a href="/tags/#arduino">arduino</a>, <a href="/tags/#esp32">esp32</a>, <a href="/tags/#iot">iot</a>, <a href="/tags/#javascript">javascript</a>, <a href="/tags/#raspberry-pi">raspberry-pi</a></span>
      
    </div>
    <h1 class="post-title">Alexa and Raspberry Pi demo (Part 2). Listening to external events</h1>
  </header>

  <section class="post">
    <p>Today I want to keep on with the <a href="https://gonzalo123.com/2019/12/16/alexa-and-raspberry-pi-demo/">previous example</a>. This time I want to create one Alexa skill that listen to external events. The example that I’ve build is the following one:</p>

<p>I’ve got one ESP32 with a proximity sensor (one HC-SR04) that is sending the distance captured each 500ms to a MQTT broker (a mosquitto server).</p>

<p>I say “Alexa, use event demo” then Alexa tell me to put my hand close to the sensor and it will tell me the distance.</p>

<p>That’s the ESP32 code</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;WiFi.h&gt;
#include &lt;PubSubClient.h&gt;
</span> 
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ssid</span> <span class="o">=</span> <span class="s">"MY_SSID"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"MY_PASSWORD"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">server</span> <span class="o">=</span> <span class="s">"mqtt.server.ip"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">topic</span> <span class="o">=</span> <span class="s">"/alert"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">clientName</span> <span class="o">=</span> <span class="s">"com.gonzalo123.esp32"</span><span class="p">;</span>
 
<span class="n">WiFiClient</span> <span class="n">wifiClient</span><span class="p">;</span>
<span class="n">PubSubClient</span> <span class="nf">client</span><span class="p">(</span><span class="n">wifiClient</span><span class="p">);</span>
 
<span class="kt">int</span> <span class="n">trigPin</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">echoPin</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">alert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">alertThreshold</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">duration</span><span class="p">,</span> <span class="n">distance_cm</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">wifiConnect</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Connecting to "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
 
  <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
 
  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"*"</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"WiFi connected: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">mqttReConnect</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Attempting MQTT connection..."</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">clientName</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"connected"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"failed, rc="</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">state</span><span class="p">());</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">" try again in 5 seconds"</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">mqttEmit</span><span class="p">(</span><span class="n">String</span> <span class="n">topic</span><span class="p">,</span> <span class="n">String</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">topic</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">trigPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">echoPin</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
 
  <span class="n">wifiConnect</span><span class="p">();</span>
  <span class="n">client</span><span class="p">.</span><span class="n">setServer</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">1883</span><span class="p">);</span>
 
  <span class="n">delay</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">mqttReConnect</span><span class="p">();</span>
  <span class="p">}</span>
 
  <span class="n">client</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
 
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">trigPin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">trigPin</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
 
  <span class="n">duration</span> <span class="o">=</span> <span class="n">pulseIn</span><span class="p">(</span><span class="n">echoPin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">distance_cm</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">/</span> <span class="mi">29</span><span class="p">;</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">distance_cm</span> <span class="o">&lt;=</span> <span class="n">alertThreshold</span> <span class="o">&amp;&amp;</span> <span class="n">alert</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">alert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Alert!"</span><span class="p">);</span>
      <span class="n">mqttEmit</span><span class="p">(</span><span class="s">"/alert"</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">distance_cm</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">distance_cm</span> <span class="o">&gt;</span> <span class="n">alertThreshold</span> <span class="o">&amp;&amp;</span> <span class="n">alert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">alert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"No alert"</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Distance: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">distance_cm</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">" cm "</span><span class="p">);</span>
 
  <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And this is my alexa skill:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span>
 
<span class="kd">const</span> <span class="nx">Alexa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">ask-sdk-core</span><span class="dl">'</span><span class="p">)</span>
 
<span class="kd">const</span> <span class="nx">RequestInterceptor</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./interceptors/RequestInterceptor</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">ResponseInterceptor</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./interceptors/ResponseInterceptor</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">LocalizationInterceptor</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./interceptors/LocalizationInterceptor</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">GadgetInterceptor</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./interceptors/GadgetInterceptor</span><span class="dl">'</span><span class="p">)</span>
 
<span class="kd">const</span> <span class="nx">YesIntentHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/YesIntentHandler</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">NoIntentHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/NoIntentHandler</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">LaunchRequestHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/LaunchRequestHandler</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">CancelAndStopIntentHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/CancelAndStopIntentHandler</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">SessionEndedRequestHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/SessionEndedRequestHandler</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">CustomInterfaceEventHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/CustomInterfaceEventHandler</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">CustomInterfaceExpirationHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/CustomInterfaceExpirationHandler</span><span class="dl">'</span><span class="p">)</span>
 
<span class="kd">const</span> <span class="nx">FallbackHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/FallbackHandler</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">ErrorHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./handlers/ErrorHandler</span><span class="dl">'</span><span class="p">)</span>
 
<span class="kd">let</span> <span class="nx">skill</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">skill</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">skill</span> <span class="o">=</span> <span class="nx">Alexa</span><span class="p">.</span><span class="nx">SkillBuilders</span><span class="p">.</span><span class="nx">custom</span><span class="p">().</span>
      <span class="nx">addRequestHandlers</span><span class="p">(</span>
        <span class="nx">LaunchRequestHandler</span><span class="p">,</span>
        <span class="nx">YesIntentHandler</span><span class="p">,</span>
        <span class="nx">NoIntentHandler</span><span class="p">,</span>
        <span class="nx">CustomInterfaceEventHandler</span><span class="p">,</span>
        <span class="nx">CustomInterfaceExpirationHandler</span><span class="p">,</span>
        <span class="nx">CancelAndStopIntentHandler</span><span class="p">,</span>
        <span class="nx">SessionEndedRequestHandler</span><span class="p">,</span>
        <span class="nx">FallbackHandler</span><span class="p">).</span>
      <span class="nx">addRequestInterceptors</span><span class="p">(</span>
        <span class="nx">RequestInterceptor</span><span class="p">,</span>
        <span class="nx">ResponseInterceptor</span><span class="p">,</span>
        <span class="nx">LocalizationInterceptor</span><span class="p">,</span>
        <span class="nx">GadgetInterceptor</span><span class="p">).</span>
      <span class="nx">addErrorHandlers</span><span class="p">(</span><span class="nx">ErrorHandler</span><span class="p">).</span><span class="nx">create</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">skill</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The process is similar to the previous example. There’s a GadgetInterceptor to find the endpointId of my Raspberry Pi. But now the Raspberry Pi must emit to the event to the skill, not the skill to the event. Now my rpi’s python script is a little bit more complicated. We need to start the main loop for the Alexa Gadget SDK but also we need to start another loop listening to a mqtt event. We need to use threads as we see in a previous <a href="https://gonzalo123.com/2019/10/07/playing-with-threads-and-python-part-2/">post</a>. That’s the script that I’m using.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">paho.mqtt.client</span> <span class="k">as</span> <span class="n">mqtt</span>
<span class="kn">from</span> <span class="nn">agt</span> <span class="kn">import</span> <span class="n">AlexaGadget</span>
 
<span class="n">logging</span><span class="p">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
 
 
<span class="k">class</span> <span class="nc">Listener</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">Queue</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Listener</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
 
    <span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rc</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Connected!"</span><span class="p">)</span>
        <span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">"/alert"</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">on_event</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">payload</span><span class="p">))</span>
 
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cm</span><span class="p">):</span>
        <span class="k">pass</span>
 
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">mqtt</span><span class="p">.</span><span class="n">Client</span><span class="p">()</span>
        <span class="n">client</span><span class="p">.</span><span class="n">on_connect</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">on_connect</span>
        <span class="n">client</span><span class="p">.</span><span class="n">on_message</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">on_message</span>
 
        <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'192.168.1.87'</span><span class="p">,</span> <span class="mi">1883</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">client</span><span class="p">.</span><span class="n">loop_forever</span><span class="p">()</span>
 
 
<span class="k">class</span> <span class="nc">Gadget</span><span class="p">(</span><span class="n">AlexaGadget</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">Listener</span><span class="p">.</span><span class="n">on_event</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_emit_event</span>
 
    <span class="k">def</span> <span class="nf">_emit_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cm</span><span class="p">):</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"_emit_event {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">'cm'</span><span class="p">:</span> <span class="n">cm</span><span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_custom_event</span><span class="p">(</span><span class="s">'Custom.gonzalo123'</span><span class="p">,</span> <span class="s">'sensor'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
 
 
<span class="n">l</span> <span class="o">=</span> <span class="n">Listener</span><span class="p">()</span>
<span class="n">l</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
 
 
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">gadget</span> <span class="o">=</span> <span class="n">Gadget</span><span class="p">()</span>
    <span class="n">gadget</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
 
 
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p><a href="https://www.youtube.com/watch?v=5DPtZTILHR8"><img src="https://img.youtube.com/vi/5DPtZTILHR8/0.jpg" alt="youtube" /></a></p>

<p>Source code in my <a href="https://github.com/gonzalo123/alexa_rpi_event">github</a></p>



  </section>
  <p>
    <div class="page-share">
  <a href="https://twitter.com/intent/tweet?text=Alexa+and+Raspberry+Pi+demo+%28Part+2%29.+Listening+to+external+events%20http%3A%2F%2Flocalhost%3A4000%2F2020%2F01%2F13%2Falexa-and-raspberry-pi-demo-part-2-listening-to-external-events%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2020%2F01%2F13%2Falexa-and-raspberry-pi-demo-part-2-listening-to-external-events%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=Alexa+and+Raspberry+Pi+demo+%28Part+2%29.+Listening+to+external+events&url=http%3A%2F%2Flocalhost%3A4000%2F2020%2F01%2F13%2Falexa-and-raspberry-pi-demo-part-2-listening-to-external-events%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

  </p>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://localhost:4000/2020/01/13/alexa-and-raspberry-pi-demo-part-2-listening-to-external-events/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2020/01/13/alexa-and-raspberry-pi-demo-part-2-listening-to-external-events'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//gonzalo123-com.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2021 Gonzalo Ayuso. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1617390999503576000"></script>


    </div>
  </body>
</html>
