<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  

  <title>Database utils for psycopg2</title>
  <meta name="description" content="I normally need to perform raw queries when I’m working with Python. Even when I’m using Django and it’s ORM I need to execute sql against the database. As I use (almost always) PostgreSQL and I use (as we all do) psycopg2. Psycopg2 is very complete and easy to use but sometimes I need a few helpers to make my usual tasks easier. I don’t want to create a complex library on top of psycopg2, only a helper.

">
  <meta name="author" content="Gonzalo Ayuso">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Database utils for psycopg2">
  <meta name="twitter:description" content="I normally need to perform raw queries when I’m working with Python. Even when I’m using Django and it’s ORM I need to execute sql against the database. As I use (almost always) PostgreSQL and I use (as we all do) psycopg2. Psycopg2 is very complete and easy to use but sometimes I need a few helpers to make my usual tasks easier. I don’t want to create a complex library on top of psycopg2, only a helper.

">
  
  <meta name="twitter:creator" content="gonzalo123">
  
  <meta name="twitter:image" content="/images/favicons/favicon-194x194.png" />

  <meta property="og:type" content="article">
  <meta property="og:title" content="Database utils for psycopg2">
  <meta property="og:description" content="I normally need to perform raw queries when I’m working with Python. Even when I’m using Django and it’s ORM I need to execute sql against the database. As I use (almost always) PostgreSQL and I use (as we all do) psycopg2. Psycopg2 is very complete and easy to use but sometimes I need a few helpers to make my usual tasks easier. I don’t want to create a complex library on top of psycopg2, only a helper.

">
  <meta property="og:image" content="/images/favicons/favicon-194x194.png" />

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <link rel="stylesheet" href="/css/main.css?1617358755669312000">
  <link rel="canonical" href="http://localhost:4000/2021/database-utils-for-psycopg2/">
  <link rel="alternate" type="application/rss+xml" title="Gonzalo Ayuso" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover panel-cover--collapsed"
  style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">
        <a href="/" title="link to home of Gonzalo Ayuso">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Gonzalo Ayuso</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/gonzalo123"
                  title="@gonzalo123 on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
              

              
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/gonzaloayuso"
                  title="gonzaloayuso on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
              

              
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/gonzalo123"
                  title="gonzalo123 on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
              

              
              <!-- Email -->
              <li class="navigation__item">
                <a href="mailto:gonzalo123@gmail.com" title="Email gonzalo123@gmail.com" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>
              

              <!-- RSS -->
              <li class="navigation__item">
                <a href="/feed.xml" title="Subscribe" target="_blank">
                  <i class="icon icon-rss"></i>
                  <span class="label">RSS</span>
                </a>
              </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="2021-02-15 00:00" class="post-meta__date date">15 Feb 2021</time>
      
      &#8226; <span class="post-meta__tags">on <a href="/tags/#postgresql">postgresql</a>, <a href="/tags/#python">python</a></span>
      
    </div>
    <h1 class="post-title">Database utils for psycopg2</h1>
  </header>

  <section class="post">
    <p>I normally need to perform raw queries when I’m working with Python. Even when I’m using Django and it’s ORM I need to execute sql against the database. As I use (almost always) PostgreSQL and I use (as we all do) psycopg2. Psycopg2 is very complete and easy to use but sometimes I need a few helpers to make my usual tasks easier. I don’t want to create a complex library on top of psycopg2, only a helper.</p>

<div id="entry-table-of-contents" class="toc-wrapper">
  <h2 id="toc-toggle" class="no_toc">
  Table of Contents <i class="toc-toggle-icon fas fa-chevron-down"></i>
</h2>
<ol id="markdown-toc">
  <li><a href="#connection" id="markdown-toc-connection">Connection</a></li>
  <li><a href="#fetch-all" id="markdown-toc-fetch-all">Fetch all</a></li>
  <li><a href="#fetch-one" id="markdown-toc-fetch-one">Fetch one</a></li>
  <li><a href="#select" id="markdown-toc-select">Select</a></li>
  <li><a href="#insert" id="markdown-toc-insert">Insert</a></li>
  <li><a href="#update" id="markdown-toc-update">Update</a></li>
  <li><a href="#delete" id="markdown-toc-delete">Delete</a></li>
  <li><a href="#upsert" id="markdown-toc-upsert">Upsert</a></li>
  <li><a href="#stored-procedures" id="markdown-toc-stored-procedures">Stored procedures</a></li>
  <li><a href="#transactions" id="markdown-toc-transactions">Transactions</a></li>
  <li><a href="#return-values" id="markdown-toc-return-values">Return values</a></li>
  <li><a href="#unit-tests" id="markdown-toc-unit-tests">Unit tests</a></li>
  <li><a href="#install" id="markdown-toc-install">Install</a></li>
</ol>

</div>

<p>Something that I miss from PHP and DBAL library is the way that DBAL helps me to create simple CRUD operations. The idea of this helper functions is to do something similar. Let’s start</p>

<p>I’ve created procedural functions to do all and also a Db class. Normally all functions needs the cursor parameter.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fetch_all</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">query</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span>
        <span class="nb">vars</span><span class="o">=</span><span class="p">{}</span> <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">params</span><span class="p">)</span>
 
    <span class="k">return</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre></div></div>

<p>The Db class accepts cursor in the constructor</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db</span> <span class="o">=</span> <span class="n">Db</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="s">"SELECT * FROM table"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="connection">Connection</h2>

<p>Nothing especial in the connection. I like to use “connection_factory=<a href="https://www.psycopg.org/docs/extras.html?highlight=namedtupleconnection#psycopg2.extras.NamedTupleConnection">NamedTupleConnection</a>” to allow me to access to the recordset as an Object. I’ve created simple factory helper to create connections:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_conn</span><span class="p">(</span><span class="n">dsn</span><span class="p">,</span> <span class="n">named_tuple</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">dsn</span><span class="o">=</span><span class="n">dsn</span><span class="p">,</span>
        <span class="n">connection_factory</span><span class="o">=</span><span class="n">NamedTupleConnection</span> <span class="k">if</span> <span class="n">named_tuple</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="n">autocommit</span>
 
    <span class="k">return</span> <span class="n">conn</span>
</code></pre></div></div>

<p>Sometimes I use <a href="https://www.psycopg.org/docs/extras.html?highlight=namedtuple#namedtuple-cursor">NamedTuple</a> in the cursor instead connection, so I’ve created a simple helper</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_cursor</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">named_tuple</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">NamedTupleCursor</span> <span class="k">if</span> <span class="n">named_tuple</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="fetch-all">Fetch all</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db</span> <span class="o">=</span> <span class="n">Db</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">db</span><span class="p">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="s">"SELECT email, name from users"</span><span class="p">):</span>
    <span class="k">assert</span> <span class="s">'user1'</span> <span class="o">==</span> <span class="n">reg</span><span class="p">.</span><span class="n">name</span>
    <span class="k">assert</span> <span class="s">'user1@email.com'</span> <span class="o">==</span> <span class="n">reg</span><span class="p">.</span><span class="n">email</span>
</code></pre></div></div>

<h2 id="fetch-one">Fetch one</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">==</span> <span class="n">db</span><span class="p">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">SQL</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="select">Select</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="s">'users'</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user1@email.com'</span><span class="p">})</span>
</code></pre></div></div>

<p>This helper only allows me to perform simple where statements (joined with AND). If I need one complex Where, then I use fetch</p>

<h2 id="insert">Insert</h2>

<p>Insert one row</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="s">'users'</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user1@email.com'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'user1'</span><span class="p">})</span>
</code></pre></div></div>

<p>Or insert multiple rows (using spycopg2’s <a href="https://www.psycopg.org/docs/cursor.html#cursor.executemany">executemany</a>)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="s">'users'</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user2@email.com'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'user2'</span><span class="p">},</span>
            <span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user3@email.com'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'user3'</span><span class="p">}</span>
        <span class="p">])</span>
</code></pre></div></div>

<p>We also can use insert_batch to insert all rows within one command</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db</span><span class="p">.</span><span class="n">insert_batch</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="s">'users'</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user2@email.com'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'user2'</span><span class="p">},</span>
            <span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user3@email.com'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'user3'</span><span class="p">}</span>
        <span class="p">])</span>
</code></pre></div></div>

<h2 id="update">Update</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db</span><span class="p">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="s">'users'</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'xxxx'</span><span class="p">},</span>
        <span class="n">identifier</span><span class="o">=</span><span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user1@email.com'</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div></div>

<h2 id="delete">Delete</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s">'users'</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user1@email.com'</span><span class="p">})</span>
</code></pre></div></div>

<h2 id="upsert">Upsert</h2>

<p>Sometimes we need to insert one row or update the row if the primary key already exists. We can do that with two statements: One select and if there isn’t any result one insert. Else on update. We can do that with one sql statement. I’ve created a helper to to that:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_upsert_sql</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="n">raw_sql</span> <span class="o">=</span> <span class="s">"""
        WITH
            upsert AS (
                UPDATE {tbl}
                SET {t_set}
                WHERE {t_where}
                RETURNING {tbl}.*),
            inserted AS (
                INSERT INTO {tbl} ({t_fields})
                SELECT {t_select_fields}
                WHERE NOT EXISTS (SELECT 1 FROM upsert)
                RETURNING *)
        SELECT * FROM upsert
        UNION ALL
        SELECT * FROM inserted
    """</span>
    <span class="n">merger_data</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">identifier</span><span class="p">}</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">SQL</span><span class="p">(</span><span class="n">raw_sql</span><span class="p">).</span><span class="nb">format</span><span class="p">(</span>
        <span class="n">tbl</span><span class="o">=</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
        <span class="n">t_set</span><span class="o">=</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">SQL</span><span class="p">(</span><span class="s">', '</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="n">_get_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
        <span class="n">t_where</span><span class="o">=</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">SQL</span><span class="p">(</span><span class="s">' and '</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="n">_get_conditions</span><span class="p">(</span><span class="n">identifier</span><span class="p">)),</span>
        <span class="n">t_fields</span><span class="o">=</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">SQL</span><span class="p">(</span><span class="s">', '</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">Identifier</span><span class="p">,</span> <span class="n">merger_data</span><span class="p">.</span><span class="n">keys</span><span class="p">())),</span>
        <span class="n">t_select_fields</span><span class="o">=</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">SQL</span><span class="p">(</span><span class="s">', '</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">Placeholder</span><span class="p">,</span> <span class="n">merger_data</span><span class="p">.</span><span class="n">keys</span><span class="p">())))</span>
 
    <span class="k">return</span> <span class="n">merger_data</span><span class="p">,</span> <span class="n">sql</span>
 
 
<span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
    <span class="n">merger_data</span><span class="p">,</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">_get_upsert_sql</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
 
    <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">merger_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="p">.</span><span class="n">rowcount</span>
</code></pre></div></div>

<p>Now we can execute a upsert in a simple way:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db</span><span class="p">.</span><span class="n">upsert</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="s">'users'</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'yyyy'</span><span class="p">},</span>
        <span class="n">identifier</span><span class="o">=</span><span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user1@email.com'</span><span class="p">})</span>
</code></pre></div></div>

<h2 id="stored-procedures">Stored procedures</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">sp_fetch_one</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="s">'hello'</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Gonzalo'</span><span class="p">})</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">sp_fetch_all</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="s">'hello'</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Gonzalo'</span><span class="p">})</span>
</code></pre></div></div>

<h2 id="transactions">Transactions</h2>

<p>In PHP and <a href="https://www.doctrine-project.org/projects/doctrine-dbal/en/2.12/reference/transactions.html">DBAL</a> to create one transaction we can use this syntax</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$conn</span><span class="o">-&gt;</span><span class="nf">transactional</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nv">$conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do stuff</span>
<span class="p">});</span>
</code></pre></div></div>

<p>In Python we can do the same with context management, but I prefer to use this syntax:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">transactional</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">db</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="s">'users'</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="p">{</span><span class="s">'email'</span><span class="p">:</span> <span class="s">'user1@email.com'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'user1'</span><span class="p">})</span>
</code></pre></div></div>

<p>The transactional function is like that (I’ve created two functions. One with raw cursor and another one with my Db class):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_transactional</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">named_tuple</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">conn</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">get_cursor</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span> <span class="n">named_tuple</span><span class="o">=</span><span class="n">named_tuple</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">callback</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">conn</span><span class="p">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">e</span>
 
<span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">transactional</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">named_tuple</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_get_transactional</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">named_tuple</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">cursor</span><span class="p">:</span> <span class="n">Db</span><span class="p">(</span><span class="n">cursor</span><span class="p">))</span>
 
 
<span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">transactional_cursor</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">named_tuple</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_get_transactional</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">named_tuple</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">cursor</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="return-values">Return values</h2>

<p>Select and fetch helpers returns the recordset, but insert, update, delete and upsert returns the number of affected rows. For example that’s the insert function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_insert_sql</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">values</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span>
 
    <span class="n">raw_sql</span> <span class="o">=</span> <span class="s">"insert into {tbl} ({t_fields}) values ({t_values})"</span>
    <span class="k">return</span> <span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">SQL</span><span class="p">(</span><span class="n">raw_sql</span><span class="p">).</span><span class="nb">format</span><span class="p">(</span>
        <span class="n">tbl</span><span class="o">=</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
        <span class="n">t_fields</span><span class="o">=</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">SQL</span><span class="p">(</span><span class="s">', '</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">Identifier</span><span class="p">,</span> <span class="n">keys</span><span class="p">)),</span>
        <span class="n">t_values</span><span class="o">=</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">SQL</span><span class="p">(</span><span class="s">', '</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">psycopg2_sql</span><span class="p">.</span><span class="n">Placeholder</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
 
 
<span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="n">_get_insert_sql</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
    <span class="n">cursor</span><span class="p">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="n">values</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
 
    <span class="k">return</span> <span class="n">cursor</span><span class="p">.</span><span class="n">rowcount</span>
</code></pre></div></div>

<h2 id="unit-tests">Unit tests</h2>

<p>You can try the library running the unit tests. I’ve also provide one docker-compose.yml file to set up a PostgreSQL database to run the tests.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.6'</span>
 
<span class="na">services</span><span class="pi">:</span>
  <span class="na">pg</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">.docker/pg</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">5432:5432</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">${POSTGRES_PASSWORD}</span>
      <span class="na">POSTGRES_USER</span><span class="pi">:</span> <span class="s">${POSTGRES_USER}</span>
      <span class="na">POSTGRES_DB</span><span class="pi">:</span> <span class="s">${POSTGRES_DB}</span>
      <span class="na">PGDATA</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/data/pgdata</span>
</code></pre></div></div>

<h2 id="install">Install</h2>

<p>You can install the library using pip</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install dbutils-gonzalo123
</code></pre></div></div>

<p>Full code in my <a href="https://github.com/gonzalo123/dbutils">github</a></p>



  </section>
  <p>
    <div class="page-share">
  <a href="https://twitter.com/intent/tweet?text=Database+utils+for+psycopg2%20http%3A%2F%2Flocalhost%3A4000%2F2021%2Fdatabase-utils-for-psycopg2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2021%2Fdatabase-utils-for-psycopg2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=Database+utils+for+psycopg2&url=http%3A%2F%2Flocalhost%3A4000%2F2021%2Fdatabase-utils-for-psycopg2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

  </p>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://localhost:4000/2021/database-utils-for-psycopg2/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2021/database-utils-for-psycopg2'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//gonzalo123-com.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2021 Gonzalo Ayuso. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1617358755669312000"></script>


    </div>
  </body>
</html>
