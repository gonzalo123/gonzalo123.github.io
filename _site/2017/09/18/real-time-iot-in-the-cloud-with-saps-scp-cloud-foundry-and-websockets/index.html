<!DOCTYPE html>
<html>
  <head>
    

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    

    <title>Real Time IoT in the cloud with SAP's SCP, Cloud Foundry and WebSockets</title>
    <meta name="description"
          content="Nowadays I’m involved with a cloud project based on SAP Cloud Platform (SCP). Side projects are the best way to mastering new technologies (at least for me) so I want to build something with SCP and my Arduino stuff. SCP comes whit one IoT module. In fact every cloud platforms have, in one way or another, one IoT module (Amazon, Azure, …). With SCP the IoT module it’s just a Hana Database where we can push our IoT values and we’re able to retrieve information via oData (the common way in SAP world).

">
    <meta name="author" content="Gonzalo Ayuso">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Real Time IoT in the cloud with SAP's SCP, Cloud Foundry and WebSockets">
    <meta name="twitter:description"
          content="Nowadays I’m involved with a cloud project based on SAP Cloud Platform (SCP). Side projects are the best way to mastering new technologies (at least for me) so I want to build something with SCP and my Arduino stuff. SCP comes whit one IoT module. In fact every cloud platforms have, in one way or another, one IoT module (Amazon, Azure, …). With SCP the IoT module it’s just a Hana Database where we can push our IoT values and we’re able to retrieve information via oData (the common way in SAP world).

">
    
    <meta name="twitter:creator" content="gonzalo123">
    
    <meta name="twitter:image" content="/images/favicons/favicon-194x194.png"/>

    <meta property="og:type" content="article">
    <meta property="og:title" content="Real Time IoT in the cloud with SAP's SCP, Cloud Foundry and WebSockets">
    <meta property="og:description"
          content="Nowadays I’m involved with a cloud project based on SAP Cloud Platform (SCP). Side projects are the best way to mastering new technologies (at least for me) so I want to build something with SCP and my Arduino stuff. SCP comes whit one IoT module. In fact every cloud platforms have, in one way or another, one IoT module (Amazon, Azure, …). With SCP the IoT module it’s just a Hana Database where we can push our IoT values and we’re able to retrieve information via oData (the common way in SAP world).

">
    <meta property="og:image" content="/images/favicons/favicon-194x194.png"/>

    <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png"
          sizes="192x192">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/images/favicons/manifest.json">
    <link rel="shortcut icon" href="/images/favicons/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="/css/main.css?1617458848690451000">
    <link rel="canonical"
          href="/2017/09/18/real-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets/">
    <link rel="alternate" type="application/rss+xml" title="Gonzalo Ayuso" href="/feed.xml">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Real Time IoT in the cloud with SAP’s SCP, Cloud Foundry and WebSockets | Gonzalo Ayuso</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Real Time IoT in the cloud with SAP’s SCP, Cloud Foundry and WebSockets" />
<meta name="author" content="Gonzalo Ayuso" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Nowadays I’m involved with a cloud project based on SAP Cloud Platform (SCP). Side projects are the best way to mastering new technologies (at least for me) so I want to build something with SCP and my Arduino stuff. SCP comes whit one IoT module. In fact every cloud platforms have, in one way or another, one IoT module (Amazon, Azure, …). With SCP the IoT module it’s just a Hana Database where we can push our IoT values and we’re able to retrieve information via oData (the common way in SAP world)." />
<meta property="og:description" content="Nowadays I’m involved with a cloud project based on SAP Cloud Platform (SCP). Side projects are the best way to mastering new technologies (at least for me) so I want to build something with SCP and my Arduino stuff. SCP comes whit one IoT module. In fact every cloud platforms have, in one way or another, one IoT module (Amazon, Azure, …). With SCP the IoT module it’s just a Hana Database where we can push our IoT values and we’re able to retrieve information via oData (the common way in SAP world)." />
<link rel="canonical" href="/2017/09/18/real-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets/" />
<meta property="og:url" content="/2017/09/18/real-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets/" />
<meta property="og:site_name" content="Gonzalo Ayuso" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-09-18T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Real Time IoT in the cloud with SAP’s SCP, Cloud Foundry and WebSockets" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"/2017/09/18/real-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets/"},"url":"/2017/09/18/real-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets/","author":{"@type":"Person","name":"Gonzalo Ayuso"},"description":"Nowadays I’m involved with a cloud project based on SAP Cloud Platform (SCP). Side projects are the best way to mastering new technologies (at least for me) so I want to build something with SCP and my Arduino stuff. SCP comes whit one IoT module. In fact every cloud platforms have, in one way or another, one IoT module (Amazon, Azure, …). With SCP the IoT module it’s just a Hana Database where we can push our IoT values and we’re able to retrieve information via oData (the common way in SAP world).","dateModified":"2017-09-18T00:00:00+02:00","datePublished":"2017-09-18T00:00:00+02:00","headline":"Real Time IoT in the cloud with SAP’s SCP, Cloud Foundry and WebSockets","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>

    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover panel-cover--collapsed"
        style="background-image: url(/images/cover.jpg)">
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content">
                <a href="/" title="link to home of Gonzalo Ayuso">
                    <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
                    <h1 class="panel-cover__title panel-title">Gonzalo Ayuso</h1>
                    <h3 class="panel-cover__title panel-title"><i>Web Architect</i></h3>
                </a>
                <div class="navigation-wrapper">
                    <h3 class="panel-cover__title panel-title"><i>Personal blog since 2008</i></h3>
                    <nav class="cover-navigation navigation--social">
                        <nav class="cover-navigation">
                            <ul class="navigation">
                                <li class="navigation__item">
                                    <a href="/about" title="about">
                                        <span>About Me</span>
                                    </a>
                                </li>
                                <li class="navigation__item">
                                    <a href="/search" title="search">
                                        <span>Search</span>
                                    </a>
                                </li>

                            </ul>
                        </nav>
                        <hr class="panel-cover__divider">
                        <ul class="navigation">
    
    <!-- Twitter -->
    <li class="navigation__item">
        <a href="http://twitter.com/gonzalo123"
           title="@gonzalo123 on Twitter" target="_blank">
            <i class="icon icon-social-twitter"></i>
            <span class="label">Twitter</span>
        </a>
    </li>
    

    
    <!-- LinkedIn -->
    <li class="navigation__item">
        <a href="https://www.linkedin.com/in/gonzaloayuso"
           title="gonzaloayuso on LinkedIn" target="_blank">
            <i class="icon icon-social-linkedin"></i>
            <span class="label">LinkedIn</span>
        </a>
    </li>
    

    
    <!-- GitHub -->
    <li class="navigation__item">
        <a href="https://www.github.com/gonzalo123"
           title="gonzalo123 on GitHub" target="_blank">
            <i class="icon icon-social-github"></i>
            <span class="label">GitHub</span>
        </a>
    </li>
    

    
    <!-- Email -->
    <li class="navigation__item">
        <a href="mailto:gonzalo123@gmail.com" title="Email gonzalo123@gmail.com"
           target="_blank">
            <i class="icon icon-mail"></i>
            <span class="label">Email</span>
        </a>
    </li>
    

    <!-- RSS -->
    <li class="navigation__item">
        <a href="/feed.xml" title="Subscribe" target="_blank">
            <i class="icon icon-rss"></i>
            <span class="label">RSS</span>
        </a>
    </li>

</ul>

                    </nav>
                    <div>
    <a href="https://leanpub.com/codigosolido"
       rel="noreferrer"
       data-ss1617366980="1">
        <img src="/assets/images/codigoSolido.png" alt="Código Sólido">
    </a>
    <p class="panel-cover__description">
        <i>
            Buy my book (Spanish) on Leanpub. (It's free but if you pay I'll donate all profits)
        </i>
    </p>
</div>

                </div>

            </div>

        </div>

        <div class="panel-cover--overlay"></div>
    </div>
</header>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <header class="post-header">
        <div class="post-meta">
            <time datetime=" 2017-09-18 00:00
            " class="post-meta__date date">18 Sep 2017</time>
            
            &#8226; <span class="post-meta__tags">on <a
                href="/tags/#cloud-foundry">cloud-foundry</a>, <a
                href="/tags/#iot">iot</a>, <a
                href="/tags/#sap">sap</a>, <a
                href="/tags/#sap-cloud-platform">sap-cloud-platform</a>, <a
                href="/tags/#websockets">websockets</a></span>
            
        </div>
        <h1 class="post-title">Real Time IoT in the cloud with SAP's SCP, Cloud Foundry and WebSockets</h1>
    </header>

    <section class="post">
        <p>Nowadays I’m involved with a cloud project based on <a href="https://cloudplatform.sap.com">SAP Cloud Platform</a> (SCP). Side projects are the best way to mastering new technologies (at least for me) so I want to build something with SCP and my Arduino stuff. SCP comes whit one IoT module. In fact every cloud platforms have, in one way or another, one IoT module (Amazon, Azure, …). With SCP the IoT module it’s just a <a href="https://www.sap.com/spain/products/hana.html">Hana</a> Database where we can push our IoT values and we’re able to retrieve information via <a href="http://www.odata.org/">oData</a> (the common way in SAP world).</p>

<p>It’s pretty straightforward to configure the IoT module with the SAP Cloud Platform Cockpit (Every thing can be done with a hana <a href="http://account.hana.ondemand.com">trial account</a>).</p>

<p><strong>NodeMcu</strong></p>

<p>First I’m going to use a simple circuit with my NodeMcu connected to my wifi network. The prototype is a potentiometer connected to the analog input. I normally use this this circuit because I can change the value just changing the potentiometer wheel. I know it’s not very usefull, but we can easily change it and use a sensor (temperature, humidity, light, …)</p>

<p><img src="/assets/images/nodemcu.png" alt="" /></p>

<p>It will send the percentage (from 0 to 100) of the position of the potentiometer directly to the cloud.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;ESP8266WiFi.h&gt;
</span> 
<span class="k">const</span> <span class="kt">int</span> <span class="n">potentiometerPin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
<span class="c1">// Wifi configuration</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ssid</span> <span class="o">=</span> <span class="s">"my-wifi-ssid"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"my-wifi-password"</span><span class="p">;</span>
 
<span class="c1">// SAP SCP specific configuration</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">host</span> <span class="o">=</span> <span class="s">"mytenant.hanatrial.ondemand.com"</span><span class="p">;</span>
<span class="n">String</span> <span class="n">device_id</span> <span class="o">=</span> <span class="s">"my-device-ide"</span><span class="p">;</span>
<span class="n">String</span> <span class="n">message_type_id</span> <span class="o">=</span> <span class="s">"my-device-type-id"</span><span class="p">;</span>
<span class="n">String</span> <span class="n">oauth_token</span> <span class="o">=</span> <span class="s">"my-oauth-token"</span><span class="p">;</span>
 
<span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"https://[mytenant].hanatrial.ondemand.com/com.sap.iotservices.mms/v1/api/http/data/"</span> <span class="o">+</span> <span class="n">device_id</span><span class="p">;</span>
 
<span class="k">const</span> <span class="kt">int</span> <span class="n">httpsPort</span> <span class="o">=</span> <span class="mi">443</span><span class="p">;</span>
 
<span class="n">WiFiClientSecure</span> <span class="n">clientTLS</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">wifiConnect</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Connecting to "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
 
  <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
 
  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"WiFi connected."</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"IP address: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="s">"{</span><span class="se">\"</span><span class="s">mode</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">async</span><span class="se">\"</span><span class="s">, </span><span class="se">\"</span><span class="s">messageType</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">"</span> <span class="o">+</span> <span class="n">message_type_id</span> <span class="o">+</span> <span class="s">"</span><span class="se">\"</span><span class="s">, </span><span class="se">\"</span><span class="s">messages</span><span class="se">\"</span><span class="s">:[{</span><span class="se">\"</span><span class="s">value</span><span class="se">\"</span><span class="s">: "</span> <span class="o">+</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">value</span> <span class="o">+</span> <span class="s">"}]}"</span><span class="p">;</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"connecting to "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clientTLS</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">httpsPort</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"connection failed"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"requesting payload: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
 
  <span class="n">clientTLS</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="s">"POST "</span><span class="p">)</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">" HTTP/1.0</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">+</span>
               <span class="s">"Host: "</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">+</span>
               <span class="s">"Content-Type: application/json;charset=utf-8</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">+</span>
               <span class="s">"Authorization: Bearer "</span> <span class="o">+</span> <span class="n">oauth_token</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">+</span>
               <span class="s">"Content-Length: "</span> <span class="o">+</span> <span class="n">payload</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n\r\n</span><span class="s">"</span> <span class="o">+</span>
               <span class="n">payload</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">);</span>
 
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"request sent"</span><span class="p">);</span>
 
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"reply was:"</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">clientTLS</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">clientTLS</span><span class="p">.</span><span class="n">readStringUntil</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="n">wifiConnect</span><span class="p">();</span>
 
  <span class="n">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="n">mem</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
 
  <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">analogRead</span><span class="p">(</span><span class="n">potentiometerPin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1010</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mem</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mem</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">sendMessage</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="n">mem</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>SCP</strong></p>

<p>SAP Cloud Platform allows us to create web applications using <a href="https://sapui5.hana.ondemand.com/">SAPUI5</a> framework easily. It also allows us to create a destination (the way that SAP’s cloud uses to connect different modules) to our IoT module. Also every Hana table can be accessed via oData so and we can retrieve the information easily within SAPIUI5.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">onAfterRendering</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>
 
    <span class="k">this</span><span class="p">.</span><span class="nx">getView</span><span class="p">().</span><span class="nx">getModel</span><span class="p">().</span><span class="nx">read</span><span class="p">(</span><span class="dl">"</span><span class="s2">/my-hana-table-odata-uri</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">urlParameters</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">$top</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="na">$orderby</span><span class="p">:</span> <span class="dl">"</span><span class="s2">G_CREATED desc</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">oData</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">/value</span><span class="dl">"</span><span class="p">,</span> <span class="nx">oData</span><span class="p">.</span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">C_VALUE</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and display in a view</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;mvc:View</span> <span class="na">controllerName=</span><span class="s">"gonzalo123.iot.controller.Main"</span> <span class="na">xmlns:html=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">xmlns:mvc=</span><span class="s">"sap.ui.core.mvc"</span>
          <span class="na">displayBlock=</span><span class="s">"true"</span> <span class="na">xmlns=</span><span class="s">"sap.m"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;App&gt;</span>
        <span class="nt">&lt;pages&gt;</span>
            <span class="nt">&lt;Page</span> <span class="na">title=</span><span class="s">"{i18n&gt;title}"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;content&gt;</span>
                    <span class="nt">&lt;GenericTile</span> <span class="na">class=</span><span class="s">"sapUiTinyMarginBegin sapUiTinyMarginTop tileLayout"</span> <span class="na">header=</span><span class="s">"nodemcu"</span> <span class="na">frameType=</span><span class="s">"OneByOne"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;tileContent&gt;</span>
                            <span class="nt">&lt;TileContent</span> <span class="na">unit=</span><span class="s">"%"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;content&gt;</span>
                                    <span class="nt">&lt;NumericContent</span> <span class="na">value=</span><span class="s">"{view&gt;/value}"</span> <span class="na">icon=</span><span class="s">"sap-icon://line-charts"</span><span class="nt">/&gt;</span>
                                <span class="nt">&lt;/content&gt;</span>
                            <span class="nt">&lt;/TileContent&gt;</span>
                        <span class="nt">&lt;/tileContent&gt;</span>
                    <span class="nt">&lt;/GenericTile&gt;</span>
                <span class="nt">&lt;/content&gt;</span>
            <span class="nt">&lt;/Page&gt;</span>
        <span class="nt">&lt;/pages&gt;</span>
    <span class="nt">&lt;/App&gt;</span>
<span class="nt">&lt;/mvc:View&gt;</span>
</code></pre></div></div>

<p><strong>Cloud Foundry</strong></p>

<p>The web application (with SCP and SAPUI5) can access to IoT values via oData. We can fetch data again and again, but that’s not cool. We want real time updates in the web application. So we need WebSockets. SCP IoT module allows us to use WebSockets to put information, but not get updates (afaik. Let me know if I’m wrong). We also can connect our IoT to an existing MQTT server, but in this prototype I only want to use websockets. So we’re going to create a simple WebSocket server with node and <a href="https://socket.io/">socket.io</a>. This server will be listening to devices updates (again and again with a setInterval function via oData) and when it detects a change it will emit a broadcast to the WebSocket.</p>

<p>SAP’s SCP also allows us to create services with <a href="https://cloudplatform.sap.com/capabilities/runtimes-containers/cloud-foundry.html">Cloud Foundry</a>. So we’ll create our nodejs server there.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">),</span>
    <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">socket.io</span><span class="dl">'</span><span class="p">),</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request</span><span class="dl">'</span><span class="p">),</span>
    <span class="nx">auth</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Basic </span><span class="dl">"</span> <span class="o">+</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">USER</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">:</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PASS</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">"</span><span class="s2">base64</span><span class="dl">"</span><span class="p">),</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">IOT_ODATA</span><span class="p">,</span>
    <span class="nx">INTERVAL</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">INTERVAL</span><span class="p">,</span>
    <span class="nx">socket</span><span class="p">,</span>
    <span class="nx">value</span><span class="p">;</span>
 
<span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">();</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
 
<span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
 
<span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="kd">get</span><span class="p">({</span>
        <span class="na">url</span><span class="p">:</span> <span class="nx">url</span><span class="p">,</span>
        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">:</span> <span class="nx">auth</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Accept</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newValue</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">).</span><span class="nx">d</span><span class="p">.</span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">C_VALUE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">value</span><span class="dl">'</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">},</span> <span class="nx">INTERVAL</span><span class="p">);</span>
</code></pre></div></div>

<p>And that’s all. My NodeMcu device connected to the cloud.</p>

<p>Full project available in my <a href="https://github.com/gonzalo123/scp-iot-demo">github</a></p>



    </section>
    <p>
        <div class="page-share">
  <a href="https://twitter.com/intent/tweet?text=Real+Time+IoT+in+the+cloud+with+SAP%27s+SCP%2C+Cloud+Foundry+and+WebSockets%20%2F2017%2F09%2F18%2Freal-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2F2017%2F09%2F18%2Freal-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=Real+Time+IoT+in+the+cloud+with+SAP%27s+SCP%2C+Cloud+Foundry+and+WebSockets&url=%2F2017%2F09%2F18%2Freal-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

    </p>
    
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = '/2017/09/18/real-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2017/09/18/real-time-iot-in-the-cloud-with-saps-scp-cloud-foundry-and-websockets'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//gonzalo123-com.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




<div class="relatedPosts">

<h4>Related Posts:</h4>





  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2019/01/14/using-cache-buster-with-openui5-outside-scp/">Using cache buster with OpenUI5 outside SCP <span class="label label-default">sap</span>  <span class="label label-default">sap-cloud-platform</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2018/10/08/working-with-sapui5-locally-part-3-adding-more-services-in-docker/">Working with SAPUI5 locally (part 3). Adding more services in Docker <span class="label label-default">sap</span>  <span class="label label-default">websockets</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2018/08/20/working-with-sapui5-locally-and-deploying-in-scp/">Working with SAPUI5 locally and deploying in SCP <span class="label label-default">sap</span>  <span class="label label-default">sap-cloud-platform</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2017/10/23/playing-with-iot-mqtt-arduino-and-raspberry-pi-building-a-dashboard-with-openui5/">Playing with IoT, MQTT, Arduino and Raspberry Pi. Building a dashboard with OpenUI5 <span class="label label-default">iot</span>  <span class="label label-default">sap</span> </a></h5>
      </div>
      
      
        

</div>

      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2021 Gonzalo Ayuso. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1617458848690451000"></script>

    </div>
  </body>
</html>
