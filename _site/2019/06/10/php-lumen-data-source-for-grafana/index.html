<!DOCTYPE html>
<html>
  <head>
    

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    

    <title>PHP/Lumen data source for Grafana</title>
    <meta name="description"
          content="Today I need to integrate a third party service into Grafana. I cannot access directly to the service’s database, so I will integrate via JSON datasource. Grafana allows us to build custom data sources but in this case I don’t need to create a new one. I can use the simple JSON datasource

">
    <meta name="author" content="Gonzalo Ayuso">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="PHP/Lumen data source for Grafana">
    <meta name="twitter:description"
          content="Today I need to integrate a third party service into Grafana. I cannot access directly to the service’s database, so I will integrate via JSON datasource. Grafana allows us to build custom data sources but in this case I don’t need to create a new one. I can use the simple JSON datasource

">
    
    <meta name="twitter:creator" content="gonzalo123">
    
    <meta name="twitter:image" content="/images/favicons/favicon-194x194.png"/>

    <meta property="og:type" content="article">
    <meta property="og:title" content="PHP/Lumen data source for Grafana">
    <meta property="og:description"
          content="Today I need to integrate a third party service into Grafana. I cannot access directly to the service’s database, so I will integrate via JSON datasource. Grafana allows us to build custom data sources but in this case I don’t need to create a new one. I can use the simple JSON datasource

">
    <meta property="og:image" content="/images/favicons/favicon-194x194.png"/>

    <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png"
          sizes="192x192">
    <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/images/favicons/manifest.json">
    <link rel="shortcut icon" href="/images/favicons/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="/css/main.css?1617650803001959000">
    <link rel="canonical"
          href="/2019/06/10/php-lumen-data-source-for-grafana/">
    <link rel="alternate" type="application/rss+xml" title="Gonzalo Ayuso" href="/feed.xml">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>PHP/Lumen data source for Grafana | Gonzalo Ayuso</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="PHP/Lumen data source for Grafana" />
<meta name="author" content="Gonzalo Ayuso" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Today I need to integrate a third party service into Grafana. I cannot access directly to the service’s database, so I will integrate via JSON datasource. Grafana allows us to build custom data sources but in this case I don’t need to create a new one. I can use the simple JSON datasource" />
<meta property="og:description" content="Today I need to integrate a third party service into Grafana. I cannot access directly to the service’s database, so I will integrate via JSON datasource. Grafana allows us to build custom data sources but in this case I don’t need to create a new one. I can use the simple JSON datasource" />
<link rel="canonical" href="/2019/06/10/php-lumen-data-source-for-grafana/" />
<meta property="og:url" content="/2019/06/10/php-lumen-data-source-for-grafana/" />
<meta property="og:site_name" content="Gonzalo Ayuso" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-10T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PHP/Lumen data source for Grafana" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"/2019/06/10/php-lumen-data-source-for-grafana/"},"url":"/2019/06/10/php-lumen-data-source-for-grafana/","author":{"@type":"Person","name":"Gonzalo Ayuso"},"description":"Today I need to integrate a third party service into Grafana. I cannot access directly to the service’s database, so I will integrate via JSON datasource. Grafana allows us to build custom data sources but in this case I don’t need to create a new one. I can use the simple JSON datasource","dateModified":"2019-06-10T00:00:00+02:00","datePublished":"2019-06-10T00:00:00+02:00","headline":"PHP/Lumen data source for Grafana","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>

    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover panel-cover--collapsed"
        style="background-image: url(/images/cover.jpg)">
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content">
                <a href="/" title="link to home of Gonzalo Ayuso">
                    <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
                    <h1 class="panel-cover__title panel-title">Gonzalo Ayuso</h1>
                    <h3 class="panel-cover__title panel-title"><i>Web Architect</i></h3>
                </a>
                <div class="navigation-wrapper">
                    <h3 class="panel-cover__title panel-title"><i>Personal blog since 2008</i></h3>
                    <nav class="cover-navigation navigation--social">
                        <nav class="cover-navigation">
                            <ul class="navigation">
                                <li class="navigation__item">
                                    <a href="/about" title="about">
                                        <span>About Me</span>
                                    </a>
                                </li>
                                <li class="navigation__item">
                                    <a href="/posts" title="posts">
                                        <span>All</span>
                                    </a>
                                </li>
                                <li class="navigation__item">
                                    <a href="/search" title="search">
                                        <span>Search</span>
                                    </a>
                                </li>

                            </ul>
                        </nav>
                        <hr class="panel-cover__divider">
                        <ul class="navigation">
    
    <!-- Twitter -->
    <li class="navigation__item">
        <a href="http://twitter.com/gonzalo123"
           title="@gonzalo123 on Twitter" target="_blank">
            <i class="icon icon-social-twitter"></i>
            <span class="label">Twitter</span>
        </a>
    </li>
    

    
    <!-- LinkedIn -->
    <li class="navigation__item">
        <a href="https://www.linkedin.com/in/gonzaloayuso"
           title="gonzaloayuso on LinkedIn" target="_blank">
            <i class="icon icon-social-linkedin"></i>
            <span class="label">LinkedIn</span>
        </a>
    </li>
    

    
    <!-- GitHub -->
    <li class="navigation__item">
        <a href="https://www.github.com/gonzalo123"
           title="gonzalo123 on GitHub" target="_blank">
            <i class="icon icon-social-github"></i>
            <span class="label">GitHub</span>
        </a>
    </li>
    

    
    <!-- Email -->
    <li class="navigation__item">
        <a href="mailto:gonzalo123@gmail.com" title="Email gonzalo123@gmail.com"
           target="_blank">
            <i class="icon icon-mail"></i>
            <span class="label">Email</span>
        </a>
    </li>
    

    <!-- RSS -->
    <li class="navigation__item">
        <a href="/feed.xml" title="Subscribe" target="_blank">
            <i class="icon icon-rss"></i>
            <span class="label">RSS</span>
        </a>
    </li>

</ul>

                    </nav>
                    <div>
    <a href="/book">
        <img src="/assets/images/codigoSolido.png" alt="Código Sólido">
    </a>
</div>

                </div>

            </div>

        </div>

        <div class="panel-cover--overlay"></div>
    </div>
</header>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <header
            class="post-header"
            
        class="cover-banner"
        style="background-image: url(img.png);"
        
    >
        <div class="post-meta">
            <time datetime=" 2019-06-10 00:00
            " class="post-meta__date date">10 Jun 2019</time>
            
            &#8226; <span class="post-meta__tags">on <a
                href="/tags/#php">php</a>, <a
                href="/tags/#technology">technology</a>, <a
                href="/tags/#grafana">grafana</a>, <a
                href="/tags/#laravel">laravel</a>, <a
                href="/tags/#lumen">lumen</a></span>
            
        </div>
        <h1 class="post-title">PHP/Lumen data source for Grafana</h1>
    </header>

    <section class="post">
        <p>Today I need to integrate a third party service into <a href="https://grafana.com/">Grafana</a>. I cannot access directly to the service’s database, so I will integrate via JSON datasource. Grafana allows us to build <a href="https://grafana.com/docs/plugins/developing/datasources/">custom data sources</a> but in this case I don’t need to create a new one. I can use the simple <a href="https://grafana.com/plugins/grafana-simple-json-datasource">JSON datasource</a></p>

<blockquote>
  <p>grafana-cli plugins install grafana-simple-json-datasource</p>
</blockquote>

<p>Now I need to create one REST server to serve the data that our JSON datasource needs. According to the documentation we need three routes:</p>

<ul>
  <li>GET / should return 200 ok.</li>
  <li>POST /search used by the find metric options on the query tab in panels.</li>
  <li>POST /query should return metrics based on input.</li>
  <li>POST /annotations should return annotations.</li>
</ul>

<p>We’re going to create a PHP/Lumen server. Basically the routes of the application are those ones:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
 
<span class="kn">use</span> <span class="nc">Laravel\Lumen\Routing\Router</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Http\Middleware</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Laravel\Lumen\Application</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Dotenv\Dotenv</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Http\Handlers</span><span class="p">;</span>
 
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
 
<span class="p">(</span><span class="nc">Dotenv</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../env/local'</span><span class="p">))</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">();</span>
 
<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Application</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">));</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="nf">middleware</span><span class="p">([</span>
    <span class="nc">Middleware\CorsMiddleware</span><span class="o">::</span><span class="n">class</span><span class="p">,</span>
<span class="p">]);</span>
 
<span class="nv">$app</span><span class="o">-&gt;</span><span class="n">router</span><span class="o">-&gt;</span><span class="nf">group</span><span class="p">([</span><span class="s1">'middleware'</span> <span class="o">=&gt;</span> <span class="nc">Middleware\AuthMiddleware</span><span class="o">::</span><span class="n">class</span><span class="p">],</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Router</span> <span class="nv">$router</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$router</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nc">Handlers\HelloHandler</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="nv">$router</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'/search'</span><span class="p">,</span> <span class="nc">Handlers\SearchHandler</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="nv">$router</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'/query'</span><span class="p">,</span> <span class="nc">Handlers\QueryHandler</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="nv">$router</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'/annotations'</span><span class="p">,</span> <span class="nc">Handlers\AnnotationHandler</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
<span class="p">});</span>
 
<span class="k">return</span> <span class="nv">$app</span><span class="p">;</span>
</code></pre></div></div>

<p>We need to take care with CORS. I will use the Middleware that I normally use in those cases</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
 
<span class="kn">namespace</span> <span class="nn">App\Http\Middleware</span><span class="p">;</span>
 
<span class="kn">use</span> <span class="nc">Closure</span><span class="p">;</span>
 
<span class="kd">class</span> <span class="nc">CorsMiddleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="kt">Closure</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'Access-Control-Allow-Origin'</span>      <span class="o">=&gt;</span> <span class="s1">'http://localhost:3000'</span><span class="p">,</span>
            <span class="s1">'Access-Control-Allow-Methods'</span>     <span class="o">=&gt;</span> <span class="s1">'POST, GET, OPTIONS, PUT, DELETE'</span><span class="p">,</span>
            <span class="s1">'Access-Control-Allow-Credentials'</span> <span class="o">=&gt;</span> <span class="s1">'true'</span><span class="p">,</span>
            <span class="s1">'Access-Control-Max-Age'</span>           <span class="o">=&gt;</span> <span class="s1">'86400'</span><span class="p">,</span>
            <span class="s1">'Access-Control-Allow-Headers'</span>     <span class="o">=&gt;</span> <span class="s1">'accept, content-type, Content-Type, Authorization, X-Requested-With'</span><span class="p">,</span>
        <span class="p">];</span>
 
        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">isMethod</span><span class="p">(</span><span class="s1">'OPTIONS'</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">json</span><span class="p">(</span><span class="s1">'{"method":"OPTIONS"}'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">);</span>
        <span class="p">}</span>
 
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$headers</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$response</span><span class="o">-&gt;</span><span class="nb">header</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>
 
        <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I’ll use also a basic authentication so we’ll use a simple Http Basic Authentication middleware</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
 
<span class="kn">namespace</span> <span class="nn">App\Http\Middleware</span><span class="p">;</span>
 
<span class="kn">use</span> <span class="nc">Closure</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Http\Request</span><span class="p">;</span>
 
<span class="kd">class</span> <span class="nc">AuthMiddleware</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">NAME</span> <span class="o">=</span> <span class="s1">'auth.web'</span><span class="p">;</span>
 
    <span class="k">public</span> <span class="k">function</span> <span class="n">handle</span><span class="p">(</span><span class="kt">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="kt">Closure</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getUser</span><span class="p">()</span> <span class="o">!=</span> <span class="nf">env</span><span class="p">(</span><span class="s1">'HTTP_USER'</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getPassword</span><span class="p">()</span> <span class="o">!=</span> <span class="nf">env</span><span class="p">(</span><span class="s1">'HTTP_PASS'</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'WWW-Authenticate'</span> <span class="o">=&gt;</span> <span class="s1">'Basic'</span><span class="p">];</span>
 
            <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="s1">'Unauthorized'</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">);</span>
        <span class="p">}</span>
 
        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>HelloHandler is a dummy route that the datasource needs to check the connection. We only need to answer with a 200-OK</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">App\Http\Handlers</span><span class="p">;</span>
 
<span class="kd">class</span> <span class="nc">HelloHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"Ok"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>SearchHandler will return the list of available metrics that we´ll use within our grafana panels. They aren’t strictly necessary. We can return an empty array and use later one metric that it isn’t defined here (it’s only to fill the combo that grafana shows us)</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">App\Http\Handlers</span><span class="p">;</span>
 
<span class="kd">class</span> <span class="nc">SearchHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>QueryHandler is an important one. Here we’ll return the datapoints that we´ll show in grafana. For testing purposes I’ve created one handler that read the metric, and the date from and date to that grafana sends to the backend and return a random values for several metrics and fixed ones to the rest. It’s basically to see something in grafana. Later, in the real life project, I’ll query the database and return real data.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
 
<span class="kn">namespace</span> <span class="nn">App\Http\Handlers</span><span class="p">;</span>
 
<span class="kn">use</span> <span class="nc">Illuminate\Http\Request</span><span class="p">;</span>
 
<span class="kd">class</span> <span class="nc">QueryHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$json</span>   <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">json</span><span class="p">();</span>
        <span class="nv">$range</span>  <span class="o">=</span> <span class="nv">$json</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'range'</span><span class="p">);</span>
        <span class="nv">$target</span> <span class="o">=</span> <span class="nv">$json</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'targets'</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'target'</span><span class="p">];</span>
 
        <span class="nv">$tz</span>   <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">DateTimeZone</span><span class="p">(</span><span class="s1">'Europe/Madrid'</span><span class="p">);</span>
        <span class="nv">$from</span> <span class="o">=</span> <span class="err">\</span><span class="nc">DateTimeImmutable</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s2">"Y-m-d\TH:i:s.uP"</span><span class="p">,</span> <span class="nv">$range</span><span class="p">[</span><span class="s1">'from'</span><span class="p">],</span> <span class="nv">$tz</span><span class="p">);</span>
        <span class="nv">$to</span>   <span class="o">=</span> <span class="err">\</span><span class="nc">DateTimeImmutable</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s2">"Y-m-d\TH:i:s.uP"</span><span class="p">,</span> <span class="nv">$range</span><span class="p">[</span><span class="s1">'to'</span><span class="p">],</span> <span class="nv">$tz</span><span class="p">);</span>
 
        <span class="k">return</span> <span class="p">[</span><span class="s1">'target'</span> <span class="o">=&gt;</span> <span class="nv">$target</span><span class="p">,</span> <span class="s1">'datapoints'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getDataPoints</span><span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span><span class="p">,</span> <span class="nv">$target</span><span class="p">)];</span>
    <span class="p">}</span>
 
    <span class="k">private</span> <span class="k">function</span> <span class="n">getDataPoints</span><span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span><span class="p">,</span> <span class="nv">$target</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$interval</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">DateInterval</span><span class="p">(</span><span class="s1">'PT1H'</span><span class="p">);</span>
        <span class="nv">$period</span>   <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">DatePeriod</span><span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">,</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$interval</span><span class="p">));</span>
 
        <span class="nv">$dataPoints</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$period</span> <span class="k">as</span> <span class="nv">$date</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$value</span>        <span class="o">=</span> <span class="nv">$target</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="o">?</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$target</span><span class="p">;</span>
            <span class="nv">$dataPoints</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$value</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:sP'</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">];</span>
        <span class="p">}</span>
 
        <span class="k">return</span> <span class="nv">$dataPoints</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Also I’ll like to use annotations. It’s something similar. AnnotationHandler will handle this request. For this test I’ve created two types of annotations: One each hour and another one each 6 hours</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
 
<span class="kn">namespace</span> <span class="nn">App\Http\Handlers</span><span class="p">;</span>
 
<span class="kn">use</span> <span class="nc">Illuminate\Http\Request</span><span class="p">;</span>
 
<span class="kd">class</span> <span class="nc">AnnotationHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$json</span>       <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">json</span><span class="p">();</span>
        <span class="nv">$annotation</span> <span class="o">=</span> <span class="nv">$json</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'annotation'</span><span class="p">);</span>
        <span class="nv">$range</span>      <span class="o">=</span> <span class="nv">$json</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'range'</span><span class="p">);</span>
   
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getAnnotations</span><span class="p">(</span><span class="nv">$annotation</span><span class="p">,</span> <span class="nv">$range</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">private</span> <span class="k">function</span> <span class="n">getAnnotations</span><span class="p">(</span><span class="nv">$annotation</span><span class="p">,</span> <span class="nv">$range</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">(</span><span class="nv">$range</span><span class="p">,</span> <span class="s1">'PT'</span> <span class="mf">.</span> <span class="nv">$annotation</span><span class="p">[</span><span class="s1">'query'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'H'</span><span class="p">);</span>
    <span class="p">}</span>
 
 
    <span class="k">private</span> <span class="k">function</span> <span class="n">getValues</span><span class="p">(</span><span class="nv">$range</span><span class="p">,</span> <span class="nv">$int</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$tz</span>   <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">DateTimeZone</span><span class="p">(</span><span class="s1">'Europe/Madrid'</span><span class="p">);</span>
        <span class="nv">$from</span> <span class="o">=</span> <span class="err">\</span><span class="nc">DateTimeImmutable</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s2">"Y-m-d\TH:i:s.uP"</span><span class="p">,</span> <span class="nv">$range</span><span class="p">[</span><span class="s1">'from'</span><span class="p">],</span> <span class="nv">$tz</span><span class="p">);</span>
        <span class="nv">$to</span>   <span class="o">=</span> <span class="err">\</span><span class="nc">DateTimeImmutable</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s2">"Y-m-d\TH:i:s.uP"</span><span class="p">,</span> <span class="nv">$range</span><span class="p">[</span><span class="s1">'to'</span><span class="p">],</span> <span class="nv">$tz</span><span class="p">);</span>
 
        <span class="nv">$annotation</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'name'</span>       <span class="o">=&gt;</span> <span class="nv">$int</span><span class="p">,</span>
            <span class="s1">'enabled'</span>    <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s1">'datasource'</span> <span class="o">=&gt;</span> <span class="s2">"gonzalo datasource"</span><span class="p">,</span>
            <span class="s1">'showLine'</span>   <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">];</span>
 
        <span class="nv">$interval</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">DateInterval</span><span class="p">(</span><span class="nv">$int</span><span class="p">);</span>
        <span class="nv">$period</span>   <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">DatePeriod</span><span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$interval</span><span class="p">,</span> <span class="nv">$to</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$interval</span><span class="p">));</span>
 
        <span class="nv">$annotations</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$period</span> <span class="k">as</span> <span class="nv">$date</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$annotations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'annotation'</span> <span class="o">=&gt;</span> <span class="nv">$annotation</span><span class="p">,</span> <span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="s2">"H "</span> <span class="mf">.</span> <span class="nv">$date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'H'</span><span class="p">),</span> <span class="s2">"time"</span> <span class="o">=&gt;</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:sP'</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="s2">"teeext"</span><span class="p">];</span>
        <span class="p">}</span>
 
        <span class="k">return</span> <span class="nv">$annotations</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And that’s all. I’ve also put the whole example in a docker-compose file to test it</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
 
<span class="na">services</span><span class="pi">:</span>
  <span class="na">nginx</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">gonzalo123.nginx</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./src</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">.docker/Dockerfile-nginx</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./src/api:/code/src</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">gonzalo123.api</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./src</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">.docker/Dockerfile-lumen-dev</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">XDEBUG_CONFIG</span><span class="pi">:</span> <span class="s">remote_host=${MY_IP}</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./src/api:/code/src</span>
  <span class="na">grafana</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">gonzalo123.grafana</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./src</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">.docker/Dockerfile-grafana</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}</span>
      <span class="pi">-</span> <span class="s">GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}</span>
      <span class="pi">-</span> <span class="s">GF_USERS_DEFAULT_THEME=${GF_USERS_DEFAULT_THEME}</span>
      <span class="pi">-</span> <span class="s">GF_USERS_ALLOW_SIGN_UP=${GF_USERS_ALLOW_SIGN_UP}</span>
      <span class="pi">-</span> <span class="s">GF_USERS_ALLOW_ORG_CREATE=${GF_USERS_ALLOW_ORG_CREATE}</span>
      <span class="pi">-</span> <span class="s">GF_AUTH_ANONYMOUS_ENABLED=${GF_AUTH_ANONYMOUS_ENABLED}</span>
      <span class="pi">-</span> <span class="s">GF_INSTALL_PLUGINS=${GF_INSTALL_PLUGINS}</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3000:3000"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">grafana-db:/var/lib/grafana</span>
      <span class="pi">-</span> <span class="s">grafana-log:/var/log/grafana</span>
      <span class="pi">-</span> <span class="s">grafana-conf:/etc/grafana</span>
<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">grafana-db</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">grafana-log</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">grafana-conf</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
</code></pre></div></div>

<p>Here you can see the example in action:</p>

<p><img src="/assets/images/grafana.png" alt="grafana" /></p>

<p>Full code in my <a href="https://github.com/gonzalo123/grafana-php-lumen-datasource">github</a></p>

    </section>
    <p>
        <div class="page-share">
  <a href="https://twitter.com/intent/tweet?text=PHP%2FLumen+data+source+for+Grafana%20%2F2019%2F06%2F10%2Fphp-lumen-data-source-for-grafana%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2F2019%2F06%2F10%2Fphp-lumen-data-source-for-grafana%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=PHP%2FLumen+data+source+for+Grafana&url=%2F2019%2F06%2F10%2Fphp-lumen-data-source-for-grafana%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

    </p>
    
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = '/2019/06/10/php-lumen-data-source-for-grafana/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2019/06/10/php-lumen-data-source-for-grafana'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//https-gonzalo123-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




<div class="relatedPosts">

<h4>Related Posts:</h4>





  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2019/02/04/monitoring-the-bandwidth-part-2-now-with-python-nameko-microservice/">Monitoring the bandwidth (part 2) now with Python Nameko microservice <span class="label label-default">technology</span>  <span class="label label-default">grafana</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2018/10/08/working-with-sapui5-locally-part-3-adding-more-services-in-docker/">Working with SAPUI5 locally (part 3). Adding more services in Docker <span class="label label-default">php</span>  <span class="label label-default">lumen</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2018/02/19/playing-with-ionic-lumen-firebase-google-maps-raspberry-pi-and-background-geolocation/">Playing with Ionic, Lumen, Firebase, Google maps, Raspberry Pi and background geolocation <span class="label label-default">php</span>  <span class="label label-default">lumen</span> </a></h5>
      </div>
      
      
    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    

  
    
    
    

    
      <div>
      <h5><a href="/2016/10/19/silex-service-provider-for-a-gearman-wrapper/">Silex service provider for a Gearman wrapper <span class="label label-default">php</span>  <span class="label label-default">technology</span> </a></h5>
      </div>
      
      
        

</div>

      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2021 Gonzalo Ayuso. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1617650803001959000"></script>

    </div>
  </body>
</html>
